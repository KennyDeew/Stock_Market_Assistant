# –ì–¥–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ AnalyticsService

## üìã –û–±–∑–æ—Ä

AnalyticsService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Serilog** –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç:

1. **–ö–æ–Ω—Å–æ–ª—å (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)** - –≤—Å–µ –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **OpenSearch (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)** - –µ—Å–ª–∏ OpenSearch –¥–æ—Å—Ç—É–ø–µ–Ω, –ª–æ–≥–∏ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç—É–¥–∞

---

## 1. üîç –ö–æ–Ω—Å–æ–ª—å (–û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)

### –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å

**–õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Å–æ–ª—å/—Ç–µ—Ä–º–∏–Ω–∞–ª**, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ AnalyticsService.

### –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```powershell
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd src\backend\services\AnalyticsService\AnalyticsService.WebApi

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
dotnet run

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
.\scripts\start_analytics_service.ps1
```

### –ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö

#### ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Kafka:
```
[INF] –ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á –∏–∑ 1 —Å–æ–æ–±—â–µ–Ω–∏–π. –û–±—Ä–∞–±–æ—Ç–∫–∞...
[INF] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka. Offset: 123, Partition: 0
[INF] –ë–∞—Ç—á —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω: 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î
[INF] –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ 1 –∏–∑ 1 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Kafka
```

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π:
```
[WRN] –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Kafka. –¢–æ–ø–∏–∫: portfolio.transactions
[ERR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–º–∞–ø–ø–∏–Ω–≥–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ...
[ERR] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ Kafka Consumer
```

#### üîç –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Kafka:
```
[WRN] –¢–æ–ø–∏–∫ portfolio.transactions –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞...
[ERR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Kafka Consumer: ... (Code: ...)
```

---

## 2. üìä OpenSearch (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å

–ï—Å–ª–∏ OpenSearch –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –ª–æ–≥–∏ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ OpenSearch.

**URL OpenSearch Dashboard:** `http://localhost:5601` (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Docker/Aspire)

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OpenSearch

```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OpenSearch
Test-NetConnection localhost -Port 9200

# –ò–ª–∏ —á–µ—Ä–µ–∑ curl
curl http://localhost:9200
```

### –ö–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ OpenSearch

1. –û—Ç–∫—Ä–æ–π—Ç–µ OpenSearch Dashboard: `http://localhost:5601`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Discover**
3. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–µ–∫—Å: `analytics-service-YYYY.MM.DD` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `analytics-service-2025.01.30`)
4. –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ª–æ–≥–∏ –ø–æ:
   - `level`: `Information`, `Warning`, `Error`
   - `message`: –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
   - `@timestamp`: –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω

### –ò–Ω–¥–µ–∫—Å –ª–æ–≥–æ–≤

–§–æ—Ä–º–∞—Ç –∏–Ω–¥–µ–∫—Å–∞: `analytics-service-{yyyy.MM.dd}`

–ü—Ä–∏–º–µ—Ä—ã:
- `analytics-service-2025.01.30`
- `analytics-service-2025.01.31`

---

## 3. üîé –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ª–æ–≥–æ–≤ –ø–æ Kafka Consumer

### –í –∫–æ–Ω—Å–æ–ª–∏ (PowerShell)

```powershell
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –ª–æ–≥–∏
dotnet run | Select-String -Pattern "Kafka|Consumer|–±–∞—Ç—á|—Å–æ–æ–±—â–µ–Ω–∏–µ"

# –ò–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª –∏ —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ
dotnet run > logs.txt
Select-String -Path logs.txt -Pattern "Kafka|Consumer|–±–∞—Ç—á|—Å–æ–æ–±—â–µ–Ω–∏–µ"
```

### –í OpenSearch

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã:
- `message: *Kafka*`
- `message: *Consumer*`
- `message: *–±–∞—Ç—á*`
- `message: *—Å–æ–æ–±—â–µ–Ω–∏–µ*`
- `level: Error` - —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏

---

## 4. üìù –ö–ª—é—á–µ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö

### –£—Å–ø–µ—à–Ω–∞—è —Ä–∞–±–æ—Ç–∞

```
[INF] –ó–∞–ø—É—Å–∫ Kafka Consumer –¥–ª—è —Ç–æ–ø–∏–∫–∞: portfolio.transactions
[INF] –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —Ç–æ–ø–∏–∫ portfolio.transactions
[INF] –ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á –∏–∑ X —Å–æ–æ–±—â–µ–Ω–∏–π. –û–±—Ä–∞–±–æ—Ç–∫–∞...
[INF] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka. Offset: X, Partition: Y
[INF] –ë–∞—Ç—á —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω: X —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î
[INF] –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ X –∏–∑ Y —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Kafka
```

### –ü—Ä–æ–±–ª–µ–º—ã

```
[WRN] –¢–æ–ø–∏–∫ portfolio.transactions –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–æ–ø—ã—Ç–∫–∞ X/10)
[ERR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Kafka Consumer: ...
[ERR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–º–∞–ø–ø–∏–Ω–≥–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ...
[ERR] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ Kafka Consumer
[WRN] –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ X –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –±–∞—Ç—á–∞ Y
```

---

## 5. üõ†Ô∏è –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–æ–≤

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `appsettings.json`:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",  // –ò–∑–º–µ–Ω–∏—Ç–µ —Å Information –Ω–∞ Debug
      "Microsoft.AspNetCore": "Warning",
      "StockMarketAssistant.AnalyticsService.Infrastructure.EntityFramework.Kafka": "Debug"
    }
  }
}
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `appsettings.json` –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

---

## 6. üìÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ File Sink –≤ Serilog

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `Program.cs` (—Å—Ç—Ä–æ–∫–∞ 83-84):

```csharp
var loggerConfig = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.File("logs/analytics-service-.log",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 7);
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

```powershell
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å—Ç—Ä–æ–∫
Get-Content logs\analytics-service-*.log -Tail 50

# –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
Select-String -Path logs\analytics-service-*.log -Pattern "Kafka|Consumer"
```

---

## 7. üöÄ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Kafka

```powershell
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ AnalyticsService
cd src\backend\services\AnalyticsService\AnalyticsService.WebApi
dotnet run

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
.\scripts\send_test_kafka_message.ps1

# 3. –í –ª–æ–≥–∞—Ö AnalyticsService –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
# [INF] –ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á –∏–∑ 1 —Å–æ–æ–±—â–µ–Ω–∏–π. –û–±—Ä–∞–±–æ—Ç–∫–∞...
# [INF] –ë–∞—Ç—á —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω: 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î
```

---

## 8. üìû –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Kafka Consumer

```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Consumer Group
kafka-consumer-groups --bootstrap-server localhost:9092 --group analytics-service-transactions --describe

# –ü—Ä–æ–≤–µ—Ä–∫–∞ lag (–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ)
kafka-consumer-groups --bootstrap-server localhost:9092 --group analytics-service-transactions --describe | Select-String "LAG"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫–µ

```powershell
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫–µ
kafka-console-consumer --bootstrap-server localhost:9092 --topic portfolio.transactions --from-beginning --max-messages 10
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å** - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–æ–≤
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é** –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
4. **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ OpenSearch** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –ª–æ–≥–æ–≤

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `scripts/DIAGNOSTICS.md` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å Kafka Consumer
- `scripts/QUICK_TEST.md` - –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- `scripts/KAFKA_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Kafka

