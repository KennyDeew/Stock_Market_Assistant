# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Kafka, –Ω–æ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –ë–î

## –ü—Ä–æ–±–ª–µ–º–∞
–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Kafka (–≤–∏–¥–Ω–æ –ø–æ Offset), –Ω–æ –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `asset_transactions` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

## ‚úÖ –ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ AnalyticsService

```powershell
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
Get-Process | Where-Object {$_.ProcessName -like "*Analytics*"}

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
cd src\backend\services\AnalyticsService\AnalyticsService.WebApi
dotnet run
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ AnalyticsService

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**

1. **–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Kafka Consumer:**
   ```
   [Info] –ó–∞–ø—É—Å–∫ Kafka Consumer –¥–ª—è —Ç–æ–ø–∏–∫–∞: portfolio.transactions
   ```

2. **–£—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫:**
   ```
   [Info] –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —Ç–æ–ø–∏–∫ portfolio.transactions
   ```

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:**
   ```
   [Info] –ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á –∏–∑ 1 —Å–æ–æ–±—â–µ–Ω–∏–π
   ```

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
   ```
   [Info] –ë–∞—Ç—á —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω: 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î
   ```

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏:**
- `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Kafka` ‚Üí Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–º–∞–ø–ø–∏–Ω–≥–µ —Å–æ–æ–±—â–µ–Ω–∏—è` ‚Üí –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∞—Ç—á–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ —Å –ë–î

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–§–∞–π–ª:** `src/backend/services/AnalyticsService/AnalyticsService.WebApi/appsettings.json`

```json
{
  "ConnectionStrings": {
    "analytics-db": "Host=localhost;Port=5432;Database=analytics-db;Username=postgres;Password=password"
  },
  "Kafka": {
    "BootstrapServers": "localhost:9092",
    "ConsumerGroup": "analytics-service-transactions",
    "Topic": "portfolio.transactions",
    "BatchSize": 100
  }
}
```

**–í–∞–∂–Ω–æ:**
- ‚úÖ `ConnectionStrings.analytics-db` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
- ‚úÖ `Kafka.BootstrapServers` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∞–¥—Ä–µ—Å–æ–º Kafka
- ‚úÖ `Kafka.Topic` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `portfolio.transactions`

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Consumer Group

```powershell
# –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Kafka CLI
kafka-consumer-groups --bootstrap-server localhost:9092 --group analytics-service-transactions --describe
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Consumer Group —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `LAG` (–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ) = 0 (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
- –ï—Å–ª–∏ `LAG > 0`, –∑–Ω–∞—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
SELECT COUNT(*) FROM asset_transactions;

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
SELECT * FROM asset_transactions ORDER BY transaction_time DESC LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
\d asset_transactions
```

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```json
{
  "id": "606f90ce-b06c-4eac-ba40-61c7bb6618c8",
  "portfolioId": "3542233d-ccf0-4a03-b4ee-d0bb60d49a2c",
  "stockCardId": "95f08575-aca4-4867-81fb-9910b7b137fa",
  "assetType": 1,
  "transactionType": 1,
  "quantity": 100,
  "pricePerUnit": 250.75,
  "totalAmount": 25075.00,
  "transactionTime": "2025-01-29T12:00:00.000Z",
  "currency": "RUB",
  "metadata": null
}
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É.**

## üõ†Ô∏è –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```powershell
.\scripts\check_kafka_consumer.ps1
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Kafka
- ‚úÖ –ó–∞–ø—É—Å–∫ AnalyticsService
- ‚úÖ Consumer Group
- ‚úÖ –¢–æ–ø–∏–∫
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

## üîß –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: AnalyticsService –Ω–µ –∑–∞–ø—É—â–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ AnalyticsService
```powershell
cd src\backend\services\AnalyticsService\AnalyticsService.WebApi
dotnet run
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø–æ–ª–Ω–∏—Ç–µ `ConnectionStrings.analytics-db` –≤ `appsettings.json`

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ AnalyticsService
**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Kafka –ø–µ—Ä–µ–¥ AnalyticsService
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ .NET Aspire (–æ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç Kafka –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

### –ü—Ä–æ–±–ª–µ–º–∞ 4: Consumer Group –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ AnalyticsService –Ω–∞ –æ—à–∏–±–∫–∏
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ AnalyticsService
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Kafka –¥–æ—Å—Ç—É–ø–µ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 6: –°–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (Offset –≤ –ø—Ä–æ—à–ª–æ–º)
**–†–µ—à–µ–Ω–∏–µ:**
–ï—Å–ª–∏ Consumer Group —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏–º–∏ Offset, –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω—ã.

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å –Ω–æ–≤—ã–º Offset)
2. –°–±—Ä–æ—Å—å—Ç–µ Consumer Group:
   ```powershell
   kafka-consumer-groups --bootstrap-server localhost:9092 --group analytics-service-transactions --reset-offsets --to-earliest --topic portfolio.transactions --execute
   ```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] Kafka –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9092
- [ ] AnalyticsService –∑–∞–ø—É—â–µ–Ω
- [ ] –í –ª–æ–≥–∞—Ö AnalyticsService –µ—Å—Ç—å "–ó–∞–ø—É—Å–∫ Kafka Consumer"
- [ ] –í –ª–æ–≥–∞—Ö AnalyticsService –µ—Å—Ç—å "–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —Ç–æ–ø–∏–∫"
- [ ] –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –≤ appsettings.json
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ —Ç–∞–±–ª–∏—Ü–∞ asset_transactions —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [ ] Consumer Group –∞–∫—Ç–∏–≤–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ kafka-consumer-groups)
- [ ] –§–æ—Ä–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- [ ] –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è "–ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á"
- [ ] –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è "–ë–∞—Ç—á —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω"

## üöÄ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ AnalyticsService
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
   ```powershell
   .\scripts\send_test_kafka_message.ps1
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ AnalyticsService
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
   ```sql
   SELECT * FROM asset_transactions ORDER BY transaction_time DESC LIMIT 5;
   ```

