# Отчет о проверке диаграмм последовательности

## Дата проверки: 2024-12-19

## Диаграмма 1: Создание транзакции (строки 54-122)

### ✅ Правильные элементы:

1. **Последовательность вызовов** - логика корректна
2. **Валидация JWT** - выполняется в Gateway
3. **Проверка прав доступа** - проверка принадлежности портфеля пользователю
4. **Использование кэша Redis** - для StockCardService
5. **Публикация в Kafka** - после успешного COMMIT (Outbox pattern)
6. **Асинхронная обработка** - AnalyticsService и NotificationService получают события из Kafka

### ⚠️ Найденные проблемы:

#### 1. **Отсутствует проверка существования PortfolioAsset**
   - **Строка 81**: Получение PortfolioAsset по `assetId`
   - **Проблема**: Нет проверки, что PortfolioAsset существует и принадлежит указанному портфелю
   - **Рекомендация**: Добавить проверку после получения PortfolioAsset:
     ```
     alt PortfolioAsset не найден или не принадлежит портфелю
         PortfolioService-->>Gateway: 404 Not Found
         Gateway-->>Frontend: 404 Not Found
         Frontend-->>User: Ошибка: Актив не найден
     ```

#### 2. **Неточность в запросе StockCardService**
   - **Строка 84**: `HTTP GET /stockcard/{stockCardId}`
   - **Проблема**: `stockCardId` должен быть получен из `PortfolioAsset.StockCardId`
   - **Рекомендация**: Уточнить, что `stockCardId` берется из PortfolioAsset entity

#### 3. **Поток данных из Redis**
   - **Строка 88**: `Redis-->>StockCardService: StockCard data`
   - **Строка 92**: `StockCardService-->>PortfolioService: StockCard data`
   - **Проблема**: Если данные в кэше, StockCardService должен вернуть данные PortfolioService
   - **Рекомендация**: Добавить стрелку `StockCardService-->>PortfolioService` в блоке "Данные в кэше"

#### 4. **COMMIT как отдельный шаг**
   - **Строка 103**: `PortfolioService->>PortfolioDb: COMMIT транзакции`
   - **Проблема**: COMMIT обычно выполняется автоматически при завершении транзакции БД
   - **Рекомендация**: Уточнить, что это часть транзакции БД, или объединить с предыдущими операциями

---

## Диаграмма 2: Получение аналитики портфеля (строки 380-419)

### ✅ Правильные элементы:

1. **Валидация параметров** - проверка дат
2. **Использование собственной БД** - AnalyticsService использует AnalyticsDb
3. **Агрегация данных** - правильная логика обработки

### ⚠️ Критические проблемы:

#### 1. **Проблема безопасности: передача JWT токена**
   - **Строка 402**: `AnalyticsService->>PortfolioService: HTTP GET /portfolio/{portfolioId}<br/>Authorization: Bearer {token}`
   - **Критическая проблема**: AnalyticsService не должен иметь доступ к JWT токену пользователя
   - **Почему это проблема**:
     - Нарушение принципа безопасности (токен не должен передаваться между сервисами)
     - AnalyticsService может получить доступ к данным других пользователей
   - **Реальное решение** (из кода):
     - AnalyticsService получает данные из своей БД (asset_transactions, asset_ratings)
     - Эти данные реплицируются через Kafka из PortfolioService
     - AnalyticsService НЕ должен вызывать PortfolioService напрямую для получения данных портфеля
   - **Рекомендация**: Удалить вызов PortfolioService и использовать только данные из AnalyticsDb

#### 2. **Отсутствует проверка прав доступа**
   - **Проблема**: AnalyticsService не проверяет, что пользователь имеет доступ к портфелю
   - **Рекомендация**: Добавить проверку через Gateway или использовать данные из AnalyticsDb (которые уже отфильтрованы по portfolioId)

#### 3. **Неточность в запросах к БД**
   - **Строка 407**: `SELECT * FROM asset_transactions WHERE portfolio_id = {portfolioId}`
   - **Строка 410**: `SELECT * FROM asset_ratings WHERE portfolio_id = {portfolioId}`
   - **Проблема**: Условия фильтрации по датам могут быть неточными
   - **Рекомендация**: Уточнить условия:
     ```
     WHERE portfolio_id = {portfolioId}
     AND transaction_time >= {startDate}
     AND transaction_time <= {endDate}
     ```
     Для asset_ratings:
     ```
     WHERE portfolio_id = {portfolioId}
     AND period_start <= {endDate}
     AND period_end >= {startDate}
     ```

#### 4. **Отсутствует обработка ошибок**
   - **Проблема**: Нет обработки случая, когда портфель не найден или нет данных
   - **Рекомендация**: Добавить альтернативные блоки для обработки ошибок

---

## Рекомендации по исправлению

### Для диаграммы 1:
1. Добавить проверку существования PortfolioAsset
2. Уточнить поток данных из Redis
3. Объединить COMMIT с операциями БД

### Для диаграммы 2:
1. **КРИТИЧНО**: Удалить вызов PortfolioService с JWT токеном
2. Использовать только данные из AnalyticsDb (которые уже реплицированы через Kafka)
3. Добавить проверку прав доступа через Gateway (проверка должна быть до вызова AnalyticsService)
4. Уточнить условия фильтрации в SQL запросах
5. Добавить обработку ошибок

---

## Сравнение с реальной реализацией

### Диаграмма 1:
- ✅ Соответствует реальной реализации в `PortfolioAssetAppService.AddAssetTransactionAsync`
- ✅ Правильно показан Outbox pattern для Kafka
- ⚠️ Небольшие уточнения нужны в деталях

### Диаграмма 2:
- ❌ НЕ соответствует реальной реализации
- ❌ В реальном коде AnalyticsService НЕ вызывает PortfolioService с токеном
- ✅ Правильно показано использование AnalyticsDb
- ❌ Неправильно показан вызов PortfolioService

---

## Выводы

1. **Диаграмма 1** в целом правильная, требует небольших уточнений
2. **Диаграмма 2** имеет критическую проблему безопасности и не соответствует реальной реализации
3. Необходимо исправить диаграмму 2, убрав вызов PortfolioService и используя только данные из AnalyticsDb

