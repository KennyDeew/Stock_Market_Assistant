# Описание алгоритмов работы Analytics Service

Данный документ содержит описание основных алгоритмов и процедур работы сервиса аналитики с визуализацией в виде диаграмм Mermaid.

## Содержание

1. [Расчет рейтингов активов](#1-расчет-рейтингов-активов)
2. [Получение всех транзакций](#2-получение-всех-транзакций)
3. [Получение топа активов](#3-получение-топа-активов)
4. [Получение истории портфеля](#4-получение-истории-портфеля)
5. [Сравнение портфелей](#5-сравнение-портфелей)
6. [Заполнение тестовыми данными](#6-заполнение-тестовыми-данными)

---

## 1. Расчет рейтингов активов

### Описание

Алгоритм агрегирует рейтинги активов за указанный период для двух контекстов:
- **Global**: рейтинги по всем портфелям системы
- **Portfolio**: рейтинги для каждого портфеля отдельно

### Алгоритм

```mermaid
flowchart TD
    A[Начало: AggregateRatingsAsync] --> B[Получить транзакции за период]
    B --> C{Есть транзакции?}
    C -->|Нет| D[Завершить: нет данных]
    C -->|Да| E[Агрегация Global рейтингов]
    E --> F[Получить транзакции, сгруппированные по StockCardId]
    F --> G{Есть группы?}
    G -->|Нет| H[Завершить Global]
    G -->|Да| I[Для каждой группы транзакций]
    I --> J[Создать рейтинг через RatingCalculationService]
    J --> K[Добавить рейтинг в список]
    K --> L{Еще группы?}
    L -->|Да| I
    L -->|Нет| M[Назначить ранги рейтингам]
    M --> N[Сохранить рейтинги в БД]
    N --> O[Получить уникальные PortfolioId]
    O --> P{Есть портфели?}
    P -->|Нет| Q[Завершить]
    P -->|Да| R[Для каждого PortfolioId]
    R --> S[Агрегация Portfolio рейтингов]
    S --> T[Получить транзакции портфеля за период]
    T --> U[Сгруппировать по StockCardId]
    U --> V[Для каждой группы]
    V --> W[Создать рейтинг]
    W --> X[Добавить в список]
    X --> Y{Еще группы?}
    Y -->|Да| V
    Y -->|Нет| Z[Назначить ранги]
    Z --> AA[Сохранить рейтинги]
    AA --> AB{Еще портфели?}
    AB -->|Да| R
    AB -->|Нет| Q
```

### Детальный алгоритм агрегации Global рейтингов

```mermaid
flowchart TD
    A[Начало: AggregateGlobalRatingsAsync] --> B[Получить транзакции за период]
    B --> C{Транзакции найдены?}
    C -->|Нет| D[Логировать предупреждение]
    D --> E[Завершить]
    C -->|Да| F[Получить транзакции, сгруппированные по StockCardId]
    F --> G{Группы найдены?}
    G -->|Нет| H[Логировать предупреждение]
    H --> E
    G -->|Да| I[Инициализировать список рейтингов]
    I --> J[Для каждой группы транзакций]
    J --> K[Получить первую транзакцию группы]
    K --> L[Сгенерировать ticker и name]
    L --> M[Создать рейтинг через RatingCalculationService]
    M --> N{Ошибка?}
    N -->|Да| O[Логировать ошибку]
    O --> P{Еще группы?}
    N -->|Нет| Q[Добавить рейтинг в список]
    Q --> P
    P -->|Да| J
    P -->|Нет| R[Назначить ранги всем рейтингам]
    R --> S[Upsert рейтингов в БД]
    S --> T[Сохранить изменения]
    T --> U[Завершить]
```

### Детальный алгоритм агрегации Portfolio рейтингов

```mermaid
flowchart TD
    A[Начало: AggregatePortfolioRatingsAsync] --> B[Получить транзакции портфеля за период]
    B --> C[Сгруппировать транзакции по StockCardId]
    C --> D[Инициализировать список рейтингов]
    D --> E[Для каждой группы транзакций]
    E --> F[Получить первую транзакцию]
    F --> G[Сгенерировать ticker и name]
    G --> H[Создать рейтинг с контекстом Portfolio]
    H --> I{Ошибка?}
    I -->|Да| J[Логировать ошибку]
    J --> K{Еще группы?}
    I -->|Нет| L[Добавить рейтинг в список]
    L --> K
    K -->|Да| E
    K -->|Нет| M[Назначить ранги рейтингам]
    M --> N[Upsert рейтингов в БД]
    N --> O[Сохранить изменения]
    O --> P[Завершить]
```

---

## 2. Получение всех транзакций

### Описание

Алгоритм получает все транзакции за указанный период с возможностью фильтрации по типу транзакции (покупка/продажа).

### Алгоритм

```mermaid
flowchart TD
    A[Начало: GetAllTransactionsUseCase.ExecuteAsync] --> B[Определить тип периода]
    B --> C{Тип периода?}
    C -->|Today| D[Период: начало сегодня - сейчас]
    C -->|Week| E[Период: последние 7 дней]
    C -->|Month| F[Период: последний месяц]
    C -->|Custom| G{Даты указаны?}
    G -->|Нет| H[Выбросить исключение]
    G -->|Да| I[Период: StartDate - EndDate]
    C -->|Default| E
    D --> J[Получить транзакции через репозиторий]
    E --> J
    F --> J
    I --> J
    J --> K{Тип транзакции указан?}
    K -->|Да| L[Фильтровать по типу]
    K -->|Нет| M[Получить все транзакции]
    L --> N[Вернуть отфильтрованные транзакции]
    M --> N
```

---

## 3. Получение топа активов

### Описание

Алгоритм получает топ активов по количеству покупок или продаж за указанный период. Поддерживает два контекста: Global (по всем портфелям) и Portfolio (по конкретному портфелю).

### Алгоритм получения топа активов по покупкам

```mermaid
flowchart TD
    A[Начало: GetTopBoughtAssetsUseCase.ExecuteAsync] --> B[Валидация входных данных]
    B --> C{startDate < endDate?}
    C -->|Нет| D[Выбросить исключение]
    C -->|Да| E{top в диапазоне 1-Max?}
    E -->|Нет| F[Выбросить исключение]
    E -->|Да| G[Создать Period из дат]
    G --> H[Вызвать репозиторий.GetTopBoughtAsync]
    H --> I[Получить рейтинги, отсортированные по количеству покупок]
    I --> J[Вернуть топ N активов]
```

### Алгоритм получения топа активов по продажам

```mermaid
flowchart TD
    A[Начало: GetTopSoldAssetsUseCase.ExecuteAsync] --> B[Валидация входных данных]
    B --> C{startDate < endDate?}
    C -->|Нет| D[Выбросить исключение]
    C -->|Да| E{top в диапазоне 1-Max?}
    E -->|Нет| F[Выбросить исключение]
    E -->|Да| G[Создать Period из дат]
    G --> H[Вызвать репозиторий.GetTopSoldAsync]
    H --> I[Получить рейтинги, отсортированные по количеству продаж]
    I --> J[Вернуть топ N активов]
```

---

## 4. Получение истории портфеля

### Описание

Алгоритм получает историю транзакций конкретного портфеля за указанный период через PortfolioService.

### Алгоритм

```mermaid
flowchart TD
    A[Начало: GetPortfolioHistoryUseCase.ExecuteAsync] --> B[Валидация дат]
    B --> C{startDate < endDate?}
    C -->|Нет| D[Выбросить исключение]
    C -->|Да| E[Вызвать PortfolioServiceClient.GetHistoryAsync]
    E --> F{История найдена?}
    F -->|Нет| G[Логировать предупреждение]
    G --> H[Вернуть null]
    F -->|Да| I[Логировать количество транзакций]
    I --> J[Вернуть историю портфеля]
```

---

## 5. Сравнение портфелей

### Описание

Алгоритм сравнивает несколько портфелей (максимум 10) за указанный период, получая их состояния и транзакции.

### Алгоритм

```mermaid
flowchart TD
    A[Начало: ComparePortfoliosUseCase.ExecuteAsync] --> B[Валидация количества портфелей]
    B --> C{Количество <= 10?}
    C -->|Нет| D[Выбросить исключение]
    C -->|Да| E{Количество > 0?}
    E -->|Нет| F[Выбросить исключение]
    E -->|Да| G[Инициализировать результат]
    G --> H[Получить состояния портфелей через PortfolioServiceClient]
    H --> I[Сохранить состояния в результат]
    I --> J{Период указан?}
    J -->|Да| K{startDate < endDate?}
    K -->|Нет| L[Выбросить исключение]
    K -->|Да| M[Создать Period]
    J -->|Нет| N[Period = null]
    M --> O[Для каждого портфеля]
    N --> O
    O --> P{Период указан?}
    P -->|Да| Q[Получить транзакции портфеля за период]
    P -->|Нет| R[Получить все транзакции портфеля]
    Q --> S[Преобразовать в DTO]
    R --> S
    S --> T[Сохранить транзакции в результат]
    T --> U{Ошибка?}
    U -->|Да| V[Логировать ошибку]
    V --> W[Сохранить пустой список]
    W --> X{Еще портфели?}
    U -->|Нет| X
    X -->|Да| O
    X -->|Нет| Y[Вернуть результат сравнения]
```

---

## 6. Заполнение тестовыми данными

### Описание

Алгоритм заполняет базу данных тестовыми данными. Поддерживает три режима работы:
1. По конкретной транзакции (если указан transactionId)
2. По существующим транзакциям (если транзакции есть в БД)
3. Генерация фейковых данных (если транзакций нет)

После добавления транзакций автоматически запускается расчет рейтингов.

### Алгоритм

```mermaid
flowchart TD
    A[Начало: SeedDatabaseAsync] --> B{transactionId указан?}
    B -->|Да| C[Режим 1: По конкретной транзакции]
    B -->|Нет| D[Проверить наличие транзакций в БД]
    C --> E[Получить транзакцию по ID]
    E --> F{Транзакция найдена?}
    F -->|Нет| G[Вернуть ошибку]
    F -->|Да| H[Добавить транзакцию в список]
    H --> I[Определить период: день транзакции]
    I --> AA[Расчет рейтингов]
    D --> J{Транзакции есть?}
    J -->|Да| K[Режим 2: По существующим транзакциям]
    J -->|Нет| L[Режим 3: Генерация фейковых]
    K --> M[Получить все транзакции из БД]
    M --> N[Определить период: min/max даты транзакций]
    N --> O{Все в один день?}
    O -->|Да| P[Расширить период на 1 день]
    O -->|Нет| Q[Добавить буфер ±1 час]
    P --> Q
    Q --> AA
    L --> R[Создать компании]
    R --> S[Создать портфели с активами]
    S --> T[Для каждого портфеля]
    T --> U[Сгенерировать транзакции]
    U --> V[Добавить в список]
    V --> W{Еще портфели?}
    W -->|Да| T
    W -->|Нет| X[Сохранить транзакции в БД]
    X --> Y[Проверить сохранение]
    Y --> Z[Определить период: min/max даты]
    Z --> AB{Все в один день?}
    AB -->|Да| AC[Расширить период]
    AB -->|Нет| AD[Добавить буфер]
    AC --> AD
    AD --> AA
    AA --> AE{Транзакции есть и период определен?}
    AE -->|Нет| AF[Логировать предупреждение]
    AE -->|Да| AG[Вызвать CalculateRatingsAsync]
    AG --> AH[Вернуть результат]
    AF --> AH
```

### Алгоритм расчета рейтингов (CalculateRatingsAsync)

```mermaid
flowchart TD
    A[Начало: CalculateRatingsAsync] --> B[Проверить количество рейтингов до расчета]
    B --> C[Получить транзакции за период из БД]
    C --> D{Транзакции найдены?}
    D -->|Нет| E[Логировать предупреждение]
    E --> F[Получить все транзакции в БД]
    F --> G{Транзакции есть?}
    G -->|Нет| H[Логировать ошибку]
    H --> I[Завершить]
    G -->|Да| J[Определить min/max даты]
    J --> K[Расширить период]
    K --> L[Проверить транзакции в расширенном периоде]
    L --> M[Вызвать AggregateRatingsAsync]
    D -->|Да| M
    M --> N{Ошибка?}
    N -->|Да| O[Логировать детали ошибки]
    N -->|Нет| P[Проверить количество рейтингов после расчета]
    P --> Q[Логировать результат]
    Q --> I
    O --> I
```

---

## Заключение

Все описанные алгоритмы реализуют основные функции сервиса аналитики:
- Агрегация и расчет рейтингов активов
- Получение и фильтрация транзакций
- Аналитика по активам и портфелям
- Управление тестовыми данными

Каждый алгоритм включает обработку ошибок, логирование и валидацию входных данных для обеспечения надежности работы сервиса.

