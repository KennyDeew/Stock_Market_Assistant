# Task 3.2: Implement Domain Events and Event-Driven Aggregation

**Section:** Infrastructure Layer - Kafka  
**Priority:** High  
**Estimated Time:** 4-5 hours  
**Dependencies:** Tasks 3.1 (Kafka Consumer), 1.4 (Domain Services)

## Objective

Implement event-driven architecture for real-time rating aggregation triggered by transaction events.

## Requirements

### Part 1: Domain Events Infrastructure

**Interfaces (Application Layer):**
- `IDomainEvent` - base event interface
- `IEventBus` - event publishing/subscription
- `IEventHandler<TEvent>` - event handler contract

**Implementation (Infrastructure Layer):**
- `TransactionReceivedEvent` - domain event for new transactions
- `InMemoryEventBus` - in-memory event bus implementation

### Part 2: Event-Driven Aggregation

**TransactionReceivedEventHandler:**

Implement in `Infrastructure/Events/Handlers/TransactionReceivedEventHandler.cs`

**Functionality:**
1. Listen for `TransactionReceivedEvent`
2. Update Global context rating (incremental update)
3. Update Portfolio context rating (incremental update)
4. Use `RatingCalculationService.CalculateIncrementalUpdate()` for efficiency
5. Complete processing within 2 seconds (SLA)

**AssetRatingAggregationJob (Periodic Rank Recalculation):**

Implement in `Infrastructure/Jobs/AssetRatingAggregationJob.cs`

**Functionality:**
- Runs every 15 minutes
- Recalculates ranks for all ratings (not counts/amounts)
- Uses `RatingCalculationService.AssignRanks()`

## Acceptance Criteria

- [ ] IDomainEvent, IEventBus, IEventHandler in Application/Interfaces/
- [ ] TransactionReceivedEvent in Domain/Events/
- [ ] InMemoryEventBus in Infrastructure/Events/
- [ ] TransactionReceivedEventHandler implemented
- [ ] Incremental rating update working
- [ ] AssetRatingAggregationJob for periodic rank recalculation
- [ ] Event processing completes < 2 seconds
- [ ] EventBus registered as singleton in DI
- [ ] Handler registered and subscribed to EventBus

## File Structure

```
Domain/
  Events/
    TransactionReceivedEvent.cs

Application/
  Interfaces/
    IDomainEvent.cs
    IEventBus.cs
    IEventHandler.cs

Infrastructure/
  Events/
    InMemoryEventBus.cs
    Handlers/
      TransactionReceivedEventHandler.cs
  Jobs/
    AssetRatingAggregationJob.cs
```

## Performance Optimization

- Use incremental update (not full recalculation per transaction)
- Batch rank recalculation every 15 minutes
- Use database indexes for efficient queries

## Testing

- Publish TransactionReceivedEvent
- Verify rating updated in database
- Measure processing time (target < 2s)
- Verify ranks recalculated every 15 minutes