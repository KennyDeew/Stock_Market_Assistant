# Задание 2.2: Реализация репозиториев

**Раздел:** Infrastructure Layer - Database  
**Приоритет:** Высокий  
**Время:** 3-4 часа  
**Зависимости:** 2.1

## Цель

Реализовать интерфейсы репозиториев и их EF Core реализации.

## Требования

### Интерфейсы (Application Layer)

**IAssetTransactionRepository:**
- GetByIdAsync(Guid id)
- GetByPeriodAsync(DateTime start, DateTime end)
- GetByStockCardAsync(Guid stockCardId, DateTime start, DateTime end)
- GetByPortfolioAsync(Guid portfolioId, DateTime start, DateTime end)
- AddAsync(AssetTransaction transaction)
- SaveChangesAsync()

**IAssetRatingRepository:**
- GetByIdAsync(Guid id)
- GetByStockCardAndPeriodAsync(Guid stockCardId, Period period, AnalysisContext context, Guid? portfolioId)
- GetByPeriodAsync(Period period, AnalysisContext context, Guid? portfolioId)
- GetTopBoughtAsync(Period period, AnalysisContext context, Guid? portfolioId, int top)
- GetTopSoldAsync(Period period, AnalysisContext context, Guid? portfolioId, int top)
- UpsertAsync(AssetRating rating)
- UpsertBatchAsync(IEnumerable<AssetRating> ratings)
- GetDistinctPortfolioIdsAsync(Period period, AnalysisContext context)
- SaveChangesAsync()

### Реализации (Infrastructure Layer)

**Оптимизация:**
- AsNoTracking() для read-only запросов
- UpsertBatchAsync через PostgreSQL ON CONFLICT
- Использование индексов

## Критерии приёмки

- [ ] Интерфейсы в Application/Interfaces/Repositories/
- [ ] Реализации в Infrastructure/Persistence/Repositories/
- [ ] Все CRUD операции реализованы
- [ ] UpsertBatchAsync оптимизирован
- [ ] CancellationToken поддерживается
- [ ] Репозитории зарегистрированы в DI
