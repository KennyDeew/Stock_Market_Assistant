# Task 3.1: Setup Kafka Consumer

**Section:** Infrastructure Layer - Kafka  
**Priority:** High  
**Estimated Time:** 3-4 hours  
**Dependencies:** Task 2.2 (Repositories)

## Objective

Implement Kafka Consumer (Background Service) to receive portfolio transactions and save to database.

## Requirements

### Configuration

Add to `appsettings.json`:
```json
{
  "Kafka": {
    "BootstrapServers": "localhost:9092",
    "ConsumerGroup": "analytics-service-transactions",
    "Topic": "portfolio.transactions",
    "BatchSize": 100
  }
}
```

### TransactionMessage DTO

Define message structure matching PortfolioService output.

### TransactionConsumer (Background Service)

Implement in `Infrastructure/Kafka/TransactionConsumer.cs`:

**Key features:**
- Batch consumption (100 messages per batch)
- Manual offset commit after successful processing
- Error handling with Dead Letter Queue
- Publish `TransactionReceivedEvent` after save

## Acceptance Criteria

- [ ] KafkaConfiguration class exists
- [ ] TransactionMessage DTO defined
- [ ] TransactionConsumer Background Service implemented
- [ ] Batch processing (100 messages)
- [ ] Manual commit after successful batch
- [ ] Event publishing after transaction save
- [ ] Consumer registered in DI container

## File Structure

```
Infrastructure/
  Kafka/
    KafkaConfiguration.cs
    TransactionMessage.cs
    TransactionConsumer.cs
```

## Testing

Produce test messages to Kafka topic and verify:
- Transactions saved to database
- Consumer lag metrics
- Event publishing