# Задание 3.2: Доменные события и событийная агрегация

**Раздел:** Infrastructure Layer - Kafka  
**Приоритет:** Высокий  
**Время:** 4-5 часов  
**Зависимости:** 3.1, 1.4

## Цель

Реализовать event-driven архитектуру для агрегации рейтингов в реальном времени.

## Часть 1: Инфраструктура событий

### Интерфейсы (Application Layer)

```csharp
public interface IDomainEvent
{
    Guid Id { get; }
    DateTime OccurredOn { get; }
}

public interface IEventBus
{
    Task PublishAsync<TEvent>(TEvent @event, CancellationToken ct) where TEvent : IDomainEvent;
    void Subscribe<TEvent>(IEventHandler<TEvent> handler) where TEvent : IDomainEvent;
}

public interface IEventHandler<in TEvent> where TEvent : IDomainEvent
{
    Task HandleAsync(TEvent @event, CancellationToken ct);
}
```

### TransactionReceivedEvent (Domain Events)

```csharp
public class TransactionReceivedEvent : IDomainEvent
{
    public Guid Id { get; }
    public DateTime OccurredOn { get; }
    public AssetTransaction Transaction { get; }
    
    public TransactionReceivedEvent(AssetTransaction transaction)
    {
        Id = Guid.NewGuid();
        OccurredOn = DateTime.UtcNow;
        Transaction = transaction;
    }
}
```

### InMemoryEventBus (Infrastructure)

Реализация шины событий в памяти с использованием ConcurrentDictionary.

## Часть 2: Event-Driven Агрегация

### TransactionReceivedEventHandler

Местоположение: `Infrastructure/Events/Handlers/`

**Функциональность:**
1. Получить TransactionReceivedEvent
2. Обновить глобальный рейтинг (AnalysisContext.Global)
3. Обновить рейтинг портфеля (AnalysisContext.Portfolio)
4. Использовать CalculateIncrementalUpdate для оптимизации
5. Завершить за < 2 секунды (SLA)

### AssetRatingAggregationJob

Местоположение: `Infrastructure/Jobs/`

**Функциональность:**
- Запуск каждые 15 минут
- Пересчёт рангов для всех рейтингов
- Использование RatingCalculationService.AssignRanks()

## Критерии приёмки

- [ ] IDomainEvent, IEventBus, IEventHandler в Application/Interfaces/
- [ ] TransactionReceivedEvent в Domain/Events/
- [ ] InMemoryEventBus в Infrastructure/Events/
- [ ] TransactionReceivedEventHandler реализован
- [ ] Инкрементальное обновление рейтингов
- [ ] AssetRatingAggregationJob для периодического пересчёта
- [ ] Обработка < 2 секунд
- [ ] EventBus зарегистрирован как singleton
- [ ] Handler подписан на EventBus

## Структура файлов

```
Domain/
  Events/
    TransactionReceivedEvent.cs

Application/
  Interfaces/
    IDomainEvent.cs
    IEventBus.cs
    IEventHandler.cs

Infrastructure/
  Events/
    InMemoryEventBus.cs
    Handlers/
      TransactionReceivedEventHandler.cs
  Jobs/
    AssetRatingAggregationJob.cs
```
