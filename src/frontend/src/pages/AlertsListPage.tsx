import { useState, useEffect } from 'react';
import { 
  Container, 
  Typography, 
  Paper, 
  Table, 
  TableBody, 
  TableCell, 
  TableHead, 
  TableRow, 
  IconButton, 
  Alert,
  Box,
  Chip
} from '@mui/material';
import DeleteIcon from '@mui/icons-material/Delete';
import ShowChartIcon from '@mui/icons-material/ShowChart';
import TrendingDownIcon from '@mui/icons-material/TrendingDown';
import CurrencyBitcoinIcon from '@mui/icons-material/CurrencyBitcoin';
import { alertsApi } from '../services/alertsApi';
import type { AlertCondition, AlertResponse } from '../types/alertTypes';
import { getAssetTypeName, getAssetTypeColor, mapApiToUiAssetType } from '../utils/assetTypeUtils';
import AppLayout from '../components/AppLayout';

export default function AlertsListPage() {
  const [alerts, setAlerts] = useState<AlertResponse[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    loadAlerts();
  }, []);

  const loadAlerts = async () => {
    setLoading(true);
    try {
      const response = await alertsApi.getAll();
      console.log('–û—Ç–≤–µ—Ç –æ—Ç alertsApi.getAll():', response); // üîç

      if (!Array.isArray(response)) {
        console.error('–û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤, –Ω–æ –ø—Ä–∏—à—ë–ª:', response);
        setError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        setAlerts([]); // –±–µ–∑–æ–ø–∞—Å–Ω–æ
      } else {
        setAlerts(response);
      }
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', err);
      setError(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: string) => {
    if (!window.confirm('–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?')) return;
    try {
      await alertsApi.delete(id);
      setAlerts(alerts.filter(a => a.id !== id));
    } catch (err: any) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  };

  /**
   * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —É—Å–ª–æ–≤–∏–µ –≤ —Ç–µ–∫—Å—Ç
   * @param condition –£—Å–ª–æ–≤–∏–µ: Above | Below
   * @returns –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
   */
  const getConditionText = (condition: AlertCondition) => {
    switch (condition) {
      case 'Above':
        return '—Å—Ç–∞–Ω–µ—Ç ‚â•'; // –∏–ª–∏ "–≤—ã—à–µ"
      case 'Below':
        return '—Å—Ç–∞–Ω–µ—Ç ‚â§'; // –∏–ª–∏ "–Ω–∏–∂–µ"
      default:
        return condition;
    }
  };

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∫–æ–Ω–∫—É –ø–æ —Ç–∏–ø—É –∞–∫—Ç–∏–≤–∞
   * @param type –¢–∏–ø –∞–∫—Ç–∏–≤–∞
   * @returns React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–∫–æ–Ω–∫–∏
   */
  const getAssetTypeIcon = (type: string) => {
    const normalized = mapApiToUiAssetType(type);
    switch (normalized) {
      case 'stock': return <ShowChartIcon fontSize="small" />;
      case 'bond': return <TrendingDownIcon fontSize="small" />;
      case 'crypto': return <CurrencyBitcoinIcon fontSize="small" />;
      default: return <ShowChartIcon fontSize="small" />;
    }
  };

  return (
    <AppLayout>
      <Container>
        <Typography variant="h4" component="h1" gutterBottom>
          –ú–æ–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </Typography>

        {error && <Alert severity="error" sx={{ mb: 3 }}>{error}</Alert>}

        {loading ? (
          <Typography>–ó–∞–≥—Ä—É–∑–∫–∞...</Typography>
        ) : alerts.length === 0 ? (
          <Paper sx={{ p: 4, textAlign: 'center' }}>
            <Typography color="textSecondary">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫.</Typography>
          </Paper>
        ) : (
          <Paper>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>–ê–∫—Ç–∏–≤</TableCell>
                  <TableCell>–¢–∏–ø</TableCell>
                  <TableCell>–£—Å–ª–æ–≤–∏–µ</TableCell>
                  <TableCell>–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞</TableCell>
                  <TableCell>–°–æ–∑–¥–∞–Ω–æ</TableCell>
                  <TableCell align="right">–î–µ–π—Å—Ç–≤–∏—è</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {alerts.map((alert) => (
                  <TableRow key={alert.id}>
                    <TableCell>
                      <strong>{alert.ticker}</strong> ‚Äî {alert.assetName}
                    </TableCell>
                    <TableCell>
                      <Chip
                        icon={getAssetTypeIcon(alert.assetType)}
                        label={getAssetTypeName(mapApiToUiAssetType(alert.assetType))}
                        size="small"
                        sx={{
                          '&.MuiChip-root': {
                            bgcolor: (theme) => {
                              const color = getAssetTypeColor(mapApiToUiAssetType(alert.assetType));
                              return theme.palette[color].main;
                            },
                            color: 'white',
                            '& .MuiChip-icon': {
                              color: 'white !important',
                              marginLeft: '4px',
                            },
                          },
                        }}
                      />
                    </TableCell>
                    <TableCell>
                      <i>–¶–µ–Ω–∞ {getConditionText(alert.condition)}</i>
                    </TableCell>
                    <TableCell><strong>{alert.targetPrice.toFixed(2)} {alert.assetCurrency}</strong></TableCell>
                    <TableCell>
                      {new Date(alert.createdAt).toLocaleString(undefined, {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                      })}
                    </TableCell>
                    <TableCell align="right">
                      <IconButton 
                        size="small" 
                        onClick={() => handleDelete(alert.id)}
                        color="error"
                        aria-label="—É–¥–∞–ª–∏—Ç—å"
                      >
                        <DeleteIcon fontSize="small" />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </Paper>
        )}

        <Box mt={3}>
          <Typography variant="body2" color="textSecondary">
            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ.
          </Typography>
        </Box>
      </Container>
    </AppLayout>
  );
}
