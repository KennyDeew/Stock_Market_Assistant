# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI_StockCardService

on:
  push:
    branches: [ StockCardService ]
  pull_request:
    branches: [ StockCardService ]

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: stock-card-db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      mongo:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Восстановление зависимостей
      - name: Restore dependencies
        run: dotnet restore src/backend/services/StockCardService/StockCardService.WebApi

      # Сборка решения
      - name: Build solution
        run: dotnet build src/backend/services/StockCardService/StockCardService.WebApi --configuration Release --no-restore

      # Установка локального инструмента dotnet-ef
      - name: Install dotnet-ef tool
        run: |
          cd src/backend/services/StockCardService/StockCardService.WebApi
          dotnet new tool-manifest || echo "Tool manifest already exists"
          dotnet tool install dotnet-ef --version 9.0.0 || echo "dotnet-ef already installed"

      # Применение миграций EF Core
      - name: Apply EF Core migrations
        run: |
          cd src/backend/services/StockCardService/StockCardService.WebApi
          export PATH="$PATH:$PWD/.config/dotnet-tools"
          echo "Applying EF Core migrations..."
          dotnet tool run dotnet-ef database update \
            --project ../StockCardService.Infrastructure \
            --startup-project .
        env:
          ConnectionStrings__stock-card-db: "Host=localhost;Database=stock-card-db;Username=postgres;Password=password;Port=5432"

      # Прогон тестов
      - name: Run tests
        run: dotnet test src/backend/services/StockCardService/StockCardService.Tests --no-build --verbosity normal
        env:
          ASPNETCORE_ENVIRONMENT: Development
  docker-build:
    name: Build & Push Docker image
    runs-on: ubuntu-latest
    needs: build-test  # ожидание успешно пройденных тестов
    if: ${{ success() }}  # Fail-fast: сборка, только если тесты прошли успешно

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_STOCKCARD_USERNAME }}
          password: ${{ secrets.DOCKERHUB_STOCKCARD_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./src/backend/services/StockCardService/StockCardService.WebApi
          file: ./src/backend/services/StockCardService/StockCardService.WebApi/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_STOCKCARD_USERNAME }}/stockcardservice-api:latest
            ${{ secrets.DOCKERHUB_STOCKCARD_USERNAME }}/stockcardservice-api:${{ github.sha }}
